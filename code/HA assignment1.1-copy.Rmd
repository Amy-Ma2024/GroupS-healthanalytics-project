---
title: "HA assignment"
output: pdf_document
date: "2025-02-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readr)
setwd("~/Desktop")  # è®¾ç½®å·¥ä½œç›®å½•åˆ° Desktop
nhis_00014 <- read_csv("nhis_00014.csv")  # è¯»å–æ–‡ä»¶


```

## Smoking Durationæ•°æ®å¤„ç†

smoking_duration \<- df_filtered$AGE-df_filtered$SMOKAGEREG sex = as.factor(df_filtered$SEX)  # æ€§åˆ«è½¬æ¢ä¸ºå› å­
income = as.numeric(df_filtered$INCIMPPOINT5) \# ç¡®ä¿æ”¶å…¥åˆ†ä½æ˜¯æ•°å€¼å‹ family_lung_cancer = as.numeric(df_filtered\$family_lung_cancer) \# ç¡®ä¿å®¶æ—è‚ºç™Œå²æ˜¯æ•°å€¼å‹

```{r cars}

# ç¡®ä¿ SMOKESTATUS2 æ˜¯æ•°å€¼å‹
df <- nhis_00014 %>%
  mutate(SMOKESTATUS2 = as.numeric(SMOKESTATUS2))

# è¿‡æ»¤æ•°æ®ï¼šåªä¿ç•™å½“å‰å¸çƒŸè€… (SMOKESTATUS2 ä¸º 10, 11, 12, 13)
data_smokers <- df %>%
  filter(SMOKESTATUS2 %in% c(10, 11, 12, 13)) %>%  
  mutate(
    # è®¡ç®— Smoking Duration
    smoking_duration = AGE - SMOKAGEREG
  ) %>%
  # ç¡®ä¿å¸çƒŸæ—¶é•¿éè´Ÿï¼ˆæ’é™¤å¼‚å¸¸å€¼ï¼‰
  filter(smoking_duration >= 0)

# ç¡®ä¿åªåŒ…å« 10, 11, 12, 13
data_smokers <- data_smokers %>%
  filter(SMOKESTATUS2 %in% c(10, 11, 12, 13))

# æ£€æŸ¥è®¡ç®—ç»“æœï¼ˆmean/medianï¼‰
summary(df_filtered$smoking_duration)

# æ£€æŸ¥è¿‡æ»¤åçš„ SMOKESTATUS2 æ˜¯å¦æ­£ç¡®
table(data_smokers$SMOKESTATUS2)

# å¯è§†åŒ– Smoking Duration åˆ†å¸ƒ
library(ggplot2)
ggplot(df_filtered, aes(x = smoking_duration)) + 
  geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of Smoking Duration (Only Current Smokers)", 
       x = "Smoking Duration (Years)", y = "Count")


```

## Pack Year æ•°æ®å¤„ç†
```{r cars}
data_smokers <- data_smokers%>%
  mutate(CIGSDAY=as.numeric(CIGSDAY))%>%
  mutate(CIGSDAY1=as.numeric(CIGSDAY1))%>%
  mutate(CIGSDAY2=as.numeric(CIGSDAY2))

#åˆ›å»ºæ–°å˜é‡daily_smoke
data_smokers$daily_smoke <- apply(data_smokers[, c("CIGSDAY", "CIGSDAY1", "CIGSDAY2")], 1, max, na.rm = TRUE)


# å‰”é™¤ daily_smoke ä¸º 0 çš„è¡Œ
data_smokers <- data_smokers[data_smokers$daily_smoke > 0, ]

#è®¡ç®—packyear
data_packyear <- data_smokers %>%
  mutate(packyear = smoking_duration * daily_smoke / 20) %>%
  filter(packyear >= 0)
##å¯è§†åŒ–
ggplot(df_filtered, aes(x = packyear)) +
  geom_histogram(bins = 30, fill = "blue", alpha = 0.7, color = "black") +
  labs(title = "Pack-Year Distribution",
       x = "Pack-Year (Smoking Exposure)",
       y = "Count") +
  theme_minimal()
  
summary(df_filtered$packyear)

```

## å®¶åº­è‚ºç™Œå²

```{r cars}
# è¿‡æ»¤ç¬¦åˆå¹´ä»½çš„æ•°æ®ï¼ˆ2010 å’Œ 2015ï¼‰
data_family <- data_packyear %>%
  filter(YEAR %in% c(2000, 2005, 2010)) %>%  # ä»…ä¿ç•™ 2000,2005,2010 å’Œ 2015 å¹´çš„æ•°æ®
  mutate(
    # ç”Ÿæˆå®¶åº­è‚ºç™Œå²å˜é‡ï¼šå¦‚æœä»»ä½•å®¶åº­æˆå‘˜æ‚£è‚ºç™Œï¼Œåˆ™è®¾ä¸º1ï¼Œå¦åˆ™è®¾ä¸º0
    family_lung_cancer = ifelse(
      BMLGCAN == 1 | BFLGCAN == 1 | FBLGCAN == 1 | FSLGCAN == 1 | BDLGCAN == 1 | BSLGCAN == 1, 1, 0
    )
  )

library(dplyr)

# è®¡ç®— proportionï¼ˆç™¾åˆ†æ¯”ï¼‰
data_family %>%
  count(family_lung_cancer) %>%
  mutate(proportion = n / sum(n))

#1. ç»˜åˆ¶æŸ±çŠ¶å›¾ï¼ˆBar Chartï¼‰
ggplot(df_filtered, aes(x = factor(family_lung_cancer))) +
  geom_bar(fill = "blue", alpha = 0.7) +
  labs(title = "Family Lung Cancer Distribution",
       x = "Family Lung Cancer (1 = Yes, 0 = No)",
       y = "Count") +
  theme_minimal()
# 2. ç»˜åˆ¶æŒ‰å¹´ä»½åˆ†ç»„çš„æŸ±çŠ¶å›¾
ggplot(df_filtered, aes(x = factor(family_lung_cancer), fill = factor(YEAR))) +
  geom_bar(position = "dodge") +
  labs(title = "Family Lung Cancer by Year",
       x = "Family Lung Cancer (1 = Yes, 0 = No)",
       y = "Count",
       fill = "Year") +
  theme_minimal()
#3. ç»˜åˆ¶æŒ‰å¹´ä»½è®¡ç®—çš„æ¯”ä¾‹å›¾
ggplot(df_filtered, aes(x = factor(YEAR), fill = factor(family_lung_cancer))) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Family Lung Cancer by Year",
       x = "Year",
       y = "Proportion",
       fill = "Family Lung Cancer") +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal()
```
###è®¡ç®—sexçš„descriptive statistics
```{r cars}
# è®¡ç®— male å’Œ female å„è‡ªçš„æ¯”ä¾‹
df_filtered %>%
  count(SEX) %>%
  mutate(proportion = n / sum(n))  # ç¡®ä¿è¿™ä¸€è¡Œå®Œæ•´


```
### è®¡ç®—incomeçš„proportion
```{r}
install.packages("scales")  # å¦‚æœæœªå®‰è£…
library(scales)

df_filtered %>%
  count(EARNIMP1) %>%
  mutate(proportion = scales::percent(n / sum(n)))

library(ggplot2)
library(dplyr)

# è®¡ç®—å„æ”¶å…¥ç±»åˆ«çš„æ¯”ä¾‹
income_data <- df_filtered %>%
  count(EARNIMP1) %>%
  mutate(proportion = n / sum(n),
         label = paste0(round(proportion * 100, 1), "%"))  # ç”Ÿæˆæ ‡ç­¾ï¼ˆç™¾åˆ†æ¯”ï¼‰

# ç»˜åˆ¶é¥¼å›¾
ggplot(income_data, aes(x = "", y = proportion, fill = factor(EARNIMP1))) +
  geom_bar(stat = "identity", width = 1) +  # ç”»æŸ±å­
  coord_polar(theta = "y") +  # è½¬æ¢ä¸ºæåæ ‡ï¼Œå³é¥¼å›¾
  labs(title = "Income Category Proportion",
       fill = "Income Category") +
  theme_void() +  # ç§»é™¤ç½‘æ ¼å’Œåæ ‡è½´ï¼Œä½¿å…¶æ›´åƒé¥¼å›¾
  geom_text(aes(label = label), position = position_stack(vjust = 0.5))  # åœ¨é¥¼å›¾ä¸­æ·»åŠ ç™¾åˆ†æ¯”æ ‡ç­¾


```

```{r}
# è¿‡æ»¤æ‰ CNLUNG ä¸ºç©ºçš„è¡Œï¼Œå¹¶ç¡®ä¿ CNLUNG åªæœ‰ 0 å’Œ 1,è¿™å—ä¸å¤ªç¡®å®šæ˜¯ä¸æ˜¯è¿™ä¹ˆ
df_filtered <- data_family %>% 
  filter(!is.na(data_family$CNLUNG) & !is.na(data_family$SMOKAGEREG) & data_family$CNLUNG %in% c(0, 1))


```
## Descriptive statisticsæè¿°æ€§ç»Ÿè®¡
```{r}
smoking_duration <- df_filtered$AGE-df_filtered$SMOKAGEREG
sex = as.factor(df_filtered$SEX)  # æ€§åˆ«è½¬æ¢ä¸ºå› å­
income = as.numeric(df_filtered$EARNIMP1)  # ç¡®ä¿æ”¶å…¥åˆ†ä½æ˜¯æ•°å€¼å‹
family_lung_cancer = as.numeric(df_filtered$family_lung_cancer)
                                
table(df_filtered$CNLUNG)
table(df_filtered$SEX)
table(df_filtered$family_lung_cancer)
# è®¡ç®—è¿ç»­å˜é‡çš„å‡å€¼å’Œæ ‡å‡†å·®
summary(df_filtered[, c("smoking_duration", "INCIMPPOINT5")])

# å¯è§†åŒ–å¸çƒŸå˜é‡çš„åˆ†å¸ƒ
library(ggplot2)

ggplot(df_filtered, aes(x = smoking_duration, fill = as.factor(CNLUNG))) +
    geom_histogram(bins = 30, position = "dodge", color = "black", alpha = 0.7) +
    scale_fill_manual(values = c("0" = "blue", "1" = "red"), 
                      labels = c("No Lung Cancer", "Lung Cancer")) +
    labs(title = "å¸çƒŸå¹´é™ï¼ˆSmoking Durationï¼‰ä¸è‚ºç™Œçš„å…³ç³»", 
         x = "Smoking Duration (Years)", 
         y = "Count",
         fill = "Lung Cancer Status") +
    theme_minimal()

```

```
## logistic model

```{r}
logit_model_sd <- glm(CNLUNG ~ smoking_duration + sex + income + family_lung_cancer, 
                   data = df_filtered, family = binomial)
summary(logit_model_sd)
plot(logit_model_sd, 1)
plot(logit_model_sd, 2)


logit_model_py <- glm(CNLUNG ~ smoking_duration + packyear + sex + income + family_lung_cancer, 
                   data = df_filtered, family = binomial)
logit_model <- glm(CNLUNG ~ smoking_duration + packyear + sex + income + family_lung_cancer, 
                   data = df_filtered, family = binomial)

summary(logit_model)
plot(logit_model, 1)
plot(logit_model, 2)
resid(logit_model, type="working")
vif(logit_model)
```


1.  **æˆªè·é¡¹ (Intercept) = -4.438**
    -   è¿™ä¸ªå€¼è¡¨ç¤º **æ‰€æœ‰è‡ªå˜é‡å– 0 æ—¶**ï¼Œæ‚£è‚ºç™Œçš„**log-odds**ï¼ˆå¯¹æ•°ä¼˜åŠ¿æ¯”ï¼‰ã€‚
    -   ç”±äº -4.438 éå¸¸è´Ÿï¼Œè¯´æ˜**åŸºå‡†ç±»åˆ«ä¸‹æ‚£è‚ºç™Œçš„æ¦‚ç‡æä½**ã€‚
2.  **å¸çƒŸæ—¶é•¿ (smoking_duration)**
    -   **ç³»æ•° = 0.04315ï¼ŒP å€¼ \< 2e-16ï¼ˆææ˜¾è‘—ï¼‰**
    -   **è§£é‡Š**ï¼šæ¯å¢åŠ  1 å¹´å¸çƒŸæ—¶é•¿ï¼Œ**æ‚£è‚ºç™Œçš„ log-odds å¢åŠ  0.04315**ã€‚
    -   **æ¢ç®—æˆ ORï¼ˆä¼˜åŠ¿æ¯”ï¼‰**ï¼š $$
        OR = e^{0.04315} = 1.044
        $$
        -   è¿™æ„å‘³ç€ï¼Œæ¯å¢åŠ  1 å¹´å¸çƒŸæ—¶é•¿ï¼Œ**æ‚£è‚ºç™Œçš„æ¦‚ç‡å¢åŠ  4.4%**ã€‚
3.  **æ€§åˆ« (sex2)**
    -   **ç³»æ•° = 0.5748ï¼ŒP å€¼ 5.54e-09ï¼ˆææ˜¾è‘—ï¼‰**
    -   è¯´æ˜**sex=2ï¼ˆå¯èƒ½ä»£è¡¨ç”·æ€§ï¼‰**æ¯” sex=1ï¼ˆå¯èƒ½ä»£è¡¨å¥³æ€§ï¼‰æ›´å®¹æ˜“æ‚£è‚ºç™Œã€‚
    -   **æ¢ç®— OR**ï¼š $$
        OR = e^{0.5748} = 1.776
        $$
        -   **è§£é‡Š**ï¼šå¦‚æœ `sex=2`ï¼Œé‚£ä¹ˆ**æ‚£è‚ºç™Œçš„æ¦‚ç‡æ¯”åŸºå‡†ç±»åˆ«é«˜ 77.6%**ã€‚ ä½†è¿™ä¸ªåœ°æ–¹æˆ‘checkäº†ä¸€ä¸‹femaleæ˜¯2
4.  **æ”¶å…¥ (income)**
    -   **ç³»æ•° = -1.026e-06ï¼ŒP å€¼ = 0.446ï¼ˆä¸æ˜¾è‘—ï¼‰**
    -   è¯´æ˜ **æ”¶å…¥ä¸è‚ºç™Œçš„å…³ç³»ä¸æ˜¾è‘—**ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¸çƒŸä¹ æƒ¯æ‰æ˜¯ä¸»å¯¼å› ç´ ï¼Œæˆ–æ”¶å…¥çš„å½±å“è¢«å…¶ä»–å› ç´ å¸æ”¶ã€‚
5.  **å®¶æ—è‚ºç™Œå² (family_lung_cancer)**
    -   **ç³»æ•° = 0.5776ï¼ŒP å€¼ = 1.07e-08ï¼ˆææ˜¾è‘—ï¼‰**
    -   **æ¢ç®— OR**ï¼š $$
        OR = e^{0.5776} = 1.781
        $$
        -   **è§£é‡Š**ï¼šå¦‚æœæœ‰å®¶æ—è‚ºç™Œå²ï¼Œ**æ‚£è‚ºç™Œçš„æ¦‚ç‡æ¯”æ²¡æœ‰å®¶æ—è‚ºç™Œå²çš„äººé«˜ 78.1%**ã€‚

------------------------------------------------------------------------

## **2ï¸âƒ£ åå·®åˆ†æ**

### **Devianceï¼ˆæ®‹å·®åå·®ï¼‰**

-   **Null devianceï¼ˆæ— è‡ªå˜é‡çš„ devianceï¼‰** = **3564.4**
-   **Residual devianceï¼ˆåŠ ä¸Šè‡ªå˜é‡çš„ devianceï¼‰** = **3250.8**
-   **å‡å°‘é‡ = 3564.4 - 3250.8 = 313.6**
    -   Deviance ä¸‹é™ï¼Œè¯´æ˜æ¨¡å‹æœ‰ä¸€å®šçš„è§£é‡ŠåŠ›ã€‚

### **AICï¼ˆèµ¤æ± ä¿¡æ¯å‡†åˆ™ï¼‰**

-   **AIC = 3260.8**
-   AIC è¶Šä½ï¼Œæ¨¡å‹è¶Šå¥½ã€‚å¯ä»¥å’Œå…¶ä»–æ¨¡å‹æ¯”è¾ƒï¼Œé€‰æ‹© AIC æ›´å°çš„æ¨¡å‹ã€‚

------------------------------------------------------------------------

## **3ï¸âƒ£ ç»“è®º**

âœ… **å¸çƒŸæ—¶é•¿ï¼ˆsmoking_durationï¼‰æ˜¾è‘—å½±å“è‚ºç™Œé£é™©**ï¼Œæ¯å¤šå¸ 1 å¹´ï¼Œæ‚£ç—…æ¦‚ç‡å¢åŠ  4.4%ã€‚\
âœ… **æ€§åˆ«å½±å“æ˜¾è‘—**ï¼Œå¯èƒ½æ˜¯ç”·æ€§ï¼ˆsex=2ï¼‰æ¯”å¥³æ€§ï¼ˆsex=1ï¼‰æ›´å®¹æ˜“æ‚£è‚ºç™Œã€‚\
âœ… **å®¶æ—è‚ºç™Œå²æ˜¯ä¸€ä¸ªå¼ºé¢„æµ‹å› å­**ï¼Œæœ‰å®¶æ—å²çš„ä¸ªä½“æ‚£ç—…æ¦‚ç‡æ¯”æ²¡æœ‰å®¶æ—å²çš„ä¸ªä½“é«˜ 78.1%ã€‚\
âœ… **æ”¶å…¥ï¼ˆincomeï¼‰ä¸è‚ºç™Œæ— æ˜¾è‘—å…³ç³»**ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´æ¨¡å‹æˆ–æ•°æ®ã€‚\
âœ… **æ¨¡å‹æ‹Ÿåˆæ•ˆæœä¸€èˆ¬**ï¼ˆdeviance ä¸‹é™ä½†ä»æœ‰æ”¹å–„ç©ºé—´ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ï¼š - æ·»åŠ  **äº¤äº’é¡¹**ï¼ˆå¦‚ `smoking_duration * sex`ï¼‰ - å¢åŠ  **å¸çƒŸå¼ºåº¦** å˜é‡ï¼ˆå¦‚æ¯æ—¥å¸çƒŸé‡ï¼‰

------------------------------------------------------------------------

## **4ï¸âƒ£ ä¸‹ä¸€æ­¥å»ºè®®**

ğŸ”¹ **è½¬æ¢ç³»æ•°ä¸º ORï¼ˆä¼˜åŠ¿æ¯”ï¼‰**

``` r
exp(coef(logit_model))  # è®¡ç®— OR
exp(confint(logit_model))  # è®¡ç®— OR ç½®ä¿¡åŒºé—´
```

ğŸ”¹ **æ£€éªŒæ¨¡å‹æ‹Ÿåˆåº¦**

``` r
pseudo_r2 <- 1 - (logit_model$deviance / logit_model$null.deviance)
pseudo_r2  # è®¡ç®—ä¼ª RÂ²
```

å¦‚æœ `pseudo_r2` è¿‡ä½ï¼Œè¯´æ˜æ¨¡å‹è§£é‡ŠåŠ›ä¸å¼ºï¼Œå¯ä»¥è°ƒæ•´å˜é‡ã€‚

ğŸ”¹ **å¯è§†åŒ–å›å½’ç³»æ•°**

``` r
library(ggplot2)
df_OR <- data.frame(
  Variable = names(exp(coef(logit_model))),
  OR = exp(coef(logit_model)),
  Lower_CI = exp(confint(logit_model))[, 1],
  Upper_CI = exp(confint(logit_model))[, 2]
)

ggplot(df_OR[-1, ], aes(x = Variable, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI), width = 0.2) +
  coord_flip() +
  labs(title = "Odds Ratios with 95% Confidence Intervals",
       y = "Odds Ratio", x = "Variables")
```

------------------------------------------------------------------------

## **ğŸš€ æ€»ç»“**

**ç»“è®º**ï¼š 1. **å¸çƒŸæ—¶é•¿** æ˜¾è‘—å½±å“è‚ºç™Œé£é™©ã€‚ 2. **ç”·æ€§æ›´æ˜“æ‚£è‚ºç™Œ**ï¼Œæ€§åˆ«å½±å“æ˜¾è‘—ã€‚ 3. **å®¶æ—è‚ºç™Œå²æ˜¯é‡è¦çš„é¢„æµ‹å› å­**ï¼Œå½±å“æ˜¾è‘—ã€‚ 4. **æ”¶å…¥æ²¡æœ‰æ˜¾è‘—å½±å“**ï¼Œå¯èƒ½éœ€è¦é‡æ–°å®šä¹‰æˆ–åˆ†ç»„ã€‚

**ä¼˜åŒ–å»ºè®®**ï¼š - **è€ƒè™‘äº¤äº’é¡¹**ï¼ˆå¦‚ `smoking_duration * sex`ï¼‰ã€‚ - **æ£€æŸ¥å¸çƒŸå¼ºåº¦å˜é‡**ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ - **å¯¹æ¯”ä¸åŒæ¨¡å‹ï¼ˆAIC/Pseudo RÂ²ï¼‰**ï¼Œå¯»æ‰¾æœ€ä½³æ‹Ÿåˆã€‚

ğŸš€ **ä½ æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–æ¨¡å‹æˆ–æ·»åŠ æ–°å˜é‡ï¼Ÿ**


## VIFæ£€æµ‹ï¼Œç»“æœæ˜¯æ²¡æœ‰å¤§äº10çš„
``` {r}

install.packages("car")  
library(car)
vif(logit_model)

```

```{r cars}
##å»æ‰income,å› ä¸ºä¸Šä¸€ä¸ªmodelé‡Œincome p-valueå¤§äº0.05
logit_model_optimized <- glm(CNLUNG ~ smoking_duration + packyear + sex + family_lung_cancer,
                             data = df_filtered, family = binomial)
summary(logit_model_optimized)
AIC(logit_model_optimized)

logit_model_interact <- glm(CNLUNG ~ smoking_duration * sex + packyear + family_lung_cancer,
                            data = df_filtered, family = binomial)
summary(logit_model_interact)
AIC(logit_model_interact)

```

```{r}
install.packages("stargazer")
library(stargazer)

# ç”Ÿæˆå›å½’è¡¨ï¼ˆLatex/HTML/Textï¼‰
stargazer(logit_model, type = "text", title = "Regression Results", 
          dep.var.labels = "Lung Cancer Probability", 
          covariate.labels = c("Smoking Duration", "Sex", "Income", "Family Lung Cancer"),
          digits = 3, out = "regression_table.txt")

```

## **5. ç¨³å¥æ€§æ£€éªŒ**
### **(1) ä¼¼ç„¶æ¯”æ£€éªŒï¼ˆLRTï¼‰**
å¦‚æœè¦æ£€éªŒ `Smoking Duration` æ˜¯å¦åº”è¯¥ç•™åœ¨æ¨¡å‹ä¸­ï¼Œå¯ä»¥è¿›è¡Œ **ä¼¼ç„¶æ¯”æ£€éªŒï¼ˆLikelihood Ratio Test, LRTï¼‰**ï¼š
```r
```{r}
##è¿™ä¸ªæ²¡å†™ï¼Œå› ä¸ºæˆ‘modelé‡Œæ²¡åŠ pack year
library(lmtest)

```

### ORï¼ˆä¼˜åŠ¿æ¯”ï¼‰è¡¨
```{r}
exp_coef <- exp(coef(logit_model))
exp_confint <- exp(confint(logit_model))

# åˆ›å»ºè¡¨æ ¼æ•°æ®æ¡†
or_table <- data.frame(
  Variable = names(exp_coef),
  OR = exp_coef,
  Lower_CI = exp_confint[,1],
  Upper_CI = exp_confint[,2]
)

# æ‰“å° OR è¡¨
print(or_table, row.names = FALSE)

# å¯è§†åŒ– OR ç½®ä¿¡åŒºé—´
library(ggplot2)
ggplot(or_table[-1, ], aes(x = Variable, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI), width = 0.2) +
  coord_flip() +
  labs(title = "Odds Ratios and 95% Confidence Intervals",
       y = "Odds Ratio", x = "Variables")

```

##å¯è§†åŒ–
##1.å›å½’ç³»æ•°å¯è§†åŒ–ï¼ˆæˆ‘è§‰å¾—æ„ä¹‰ä¸å¤§ï¼‰
è§£é‡Š
è“ç‚¹ï¼šå›å½’ç³»æ•°ä¼°è®¡å€¼
é»‘è‰²è¯¯å·®æ¡ï¼š95% ç½®ä¿¡åŒºé—´
å¦‚æœç½®ä¿¡åŒºé—´è·¨è¿‡ 0ï¼Œè¯´æ˜è¯¥å˜é‡å¯èƒ½ä¸æ˜¾è‘—
å˜é‡æŒ‰å½±å“å¤§å°æ’åºï¼ˆå¯ä»¥è°ƒæ•´ aes(x = reorder(Variable, Estimate)ï¼‰
```{r}
library(ggplot2)

# æå–å›å½’ç³»æ•°åŠç½®ä¿¡åŒºé—´
coef_df <- data.frame(
  Variable = names(coef(logit_model)),
  Estimate = coef(logit_model),
  Lower_CI = confint(logit_model)[,1],
  Upper_CI = confint(logit_model)[,2]
)

# ç”»å‡ºå›å½’ç³»æ•°åŠå…¶ 95% ç½®ä¿¡åŒºé—´
ggplot(coef_df[-1, ], aes(x = Variable, y = Estimate)) +  # å»æ‰ Intercept
  geom_point(size = 3, color = "blue") +
  geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI), width = 0.2, color = "black") +
  coord_flip() +  # æ—‹è½¬ï¼Œä½¿å˜é‡ååœ¨ Y è½´
  theme_minimal() +
  labs(title = "Regression Coefficients with 95% Confidence Intervals",
       x = "Variables", y = "Estimate")

```
##2. ORï¼ˆä¼˜åŠ¿æ¯”ï¼‰åŠç½®ä¿¡åŒºé—´
è§£é‡Š
çº¢ç‚¹ï¼šä¼˜åŠ¿æ¯”ï¼ˆORï¼‰
é»‘è‰²è¯¯å·®æ¡ï¼š95% ç½®ä¿¡åŒºé—´
è™šçº¿ OR=1ï¼šè¶…è¿‡ 1 ä»£è¡¨é£é™©å¢åŠ ï¼Œä½äº 1 ä»£è¡¨ä¿æŠ¤ä½œç”¨
é€‚ç”¨äº è§£é‡Šå˜é‡å¯¹è‚ºç™Œçš„å½±å“å¼ºåº¦
âœ… å¦‚æœ OR = 1.78ï¼Œæ„å‘³ç€è¯¥å˜é‡ä½¿å¾—æ‚£è‚ºç™Œçš„é£é™©æé«˜ 78%
```{r}
# è®¡ç®— OR åŠç½®ä¿¡åŒºé—´
or_df <- data.frame(
  Variable = names(exp(coef(logit_model))),
  OR = exp(coef(logit_model)),
  Lower_CI = exp(confint(logit_model)[,1]),
  Upper_CI = exp(confint(logit_model)[,2])
)

# ç»˜åˆ¶ OR ç½®ä¿¡åŒºé—´å›¾
ggplot(or_df[-1, ], aes(x = Variable, y = OR)) +  # å»æ‰ Intercept
  geom_point(size = 3, color = "red") +
  geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI), width = 0.2, color = "black") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Odds Ratios with 95% Confidence Intervals",
       x = "Variables", y = "Odds Ratio") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray")  # OR=1 ä½œä¸ºå‚è€ƒçº¿

```

##3. ROC æ›²çº¿ï¼ˆè¡¡é‡æ¨¡å‹é¢„æµ‹èƒ½åŠ›ï¼‰è¿™ä¸ªä¸æ˜¯å¾ˆç¡®å®š
```{r}
library(pROC)
library(ggplot2)

# ç¡®ä¿ CNLUNG æ˜¯ 0/1
df_filtered$CNLUNG <- as.numeric(as.factor(df_filtered$CNLUNG)) - 1

# ç¡®ä¿æ•°æ®é•¿åº¦åŒ¹é…
df_filtered <- df_filtered %>% filter(!is.na(CNLUNG))
df_filtered$pred <- predict(logit_model, newdata = df_filtered, type = "response")

# è®¡ç®— AUC
roc_curve <- roc(df_filtered$CNLUNG, df_filtered$pred)

# ç»˜åˆ¶ ROC æ›²çº¿
ggplot(data.frame(TPR = roc_curve$sensitivities, FPR = 1 - roc_curve$specificities), aes(x = FPR, y = TPR)) +
  geom_line(color = "blue", size = 1.2) +
  geom_abline(linetype = "dashed") +
  theme_minimal() +
  labs(title = paste("ROC Curve (AUC =", round(auc(roc_curve), 3), ")"),
       x = "False Positive Rate (1 - Specificity)",
       y = "True Positive Rate (Sensitivity)")

```

